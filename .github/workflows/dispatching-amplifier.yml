name: Parallel Trigger with Matrix

on:
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  trigger_matrix:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        job_id: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,
                 21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,
                 41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,
                 61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,
                 81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100]
    steps:
      - name: Trigger IP.yml (shared backoff + limit detection)
        run: |
          REPO="africadick/codespace"
          WORKFLOW_FILE="IP.yml"
          REF="main"
          TOKEN="${{ secrets.PERSONAL_ACCESS_TOKEN }}"
          ITERATIONS=100
          MAX_BACKOFF=5
    
          echo "Job ${{ matrix.job_id }} starting $ITERATIONS triggers..."
    
          # ===== 每个 job 独立状态目录 =====
          STATE_DIR="state_${{ matrix.job_id }}"
          mkdir -p "$STATE_DIR"
    
          BACKOFF_FILE="$STATE_DIR/backoff.txt"
          LOCK_FILE="$STATE_DIR/backoff.lock"
          echo 1 > "$BACKOFF_FILE"
    
          SUCCESS_FILE="$STATE_DIR/success.log"
          FAIL_FILE="$STATE_DIR/fail.log"
          > "$SUCCESS_FILE"
          > "$FAIL_FILE"
    
          pids=()
    
          for i in $(seq 1 $ITERATIONS); do
          (
            while true; do
    
              HTTP_CODE=$(curl -s \
                -D "$STATE_DIR/headers_$i.txt" \
                -o "$STATE_DIR/body_$i.txt" \
                -w "%{http_code}" \
                -X POST \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer $TOKEN" \
                https://api.github.com/repos/$REPO/actions/workflows/$WORKFLOW_FILE/dispatches \
                -d "{\"ref\":\"$REF\"}")
    
              REMAINING=$(grep -i "^x-ratelimit-remaining:" "$STATE_DIR/headers_$i.txt" | awk '{print $2}' | tr -d '\r')
              RESET=$(grep -i "^x-ratelimit-reset:" "$STATE_DIR/headers_$i.txt" | awk '{print $2}' | tr -d '\r')
    
              # ===== SUCCESS =====
              if [ "$HTTP_CODE" = "204" ]; then
                echo "SUCCESS job=${{ matrix.job_id }} iter=$i"
                echo "$i" >> "$SUCCESS_FILE"
    
                (
                  flock 200
                  echo 1 > "$BACKOFF_FILE"
                ) 200>"$LOCK_FILE"
    
                break
              fi
    
              # ===== PRIMARY LIMIT =====
              if [ "$REMAINING" = "0" ]; then
                now=$(date +%s)
                wait_sec=$((RESET - now))
                if [ $wait_sec -lt 1 ]; then
                  wait_sec=5
                fi
    
                echo "PRIMARY_LIMIT job=${{ matrix.job_id }} iter=$i wait=${wait_sec}s"
                sleep $wait_sec
                continue
              fi
    
              # ===== SECONDARY LIMIT =====
              if grep -qi "secondary rate limit" "$STATE_DIR/body_$i.txt" || [ "$HTTP_CODE" = "429" ]; then
    
                (
                  flock 200
                  backoff=$(cat "$BACKOFF_FILE")
                  echo "SECONDARY_LIMIT job=${{ matrix.job_id }} iter=$i sleep=${backoff}s"
    
                  sleep "$backoff"
    
                  next=$((backoff+1))
                  if [ $next -gt $MAX_BACKOFF ]; then
                    next=$MAX_BACKOFF
                  fi
                  echo "$next" > "$BACKOFF_FILE"
                ) 200>"$LOCK_FILE"
    
                continue
              fi
    
              # ===== 其它失败 =====
              echo "FAIL job=${{ matrix.job_id }} iter=$i http=$HTTP_CODE"
              cat "$STATE_DIR/body_$i.txt"
              echo "$i http=$HTTP_CODE" >> "$FAIL_FILE"
              break
    
            done
          ) &
          pids+=($!)
          done
    
          wait
    
          success_count=$(wc -l < "$SUCCESS_FILE")
          fail_count=$(wc -l < "$FAIL_FILE")
    
          echo "=========================="
          echo "JOB ${{ matrix.job_id }} SUMMARY"
          echo "SUCCESS: $success_count"
          echo "FAIL:    $fail_count"
          echo "=========================="
