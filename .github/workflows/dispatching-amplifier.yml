name: Parallel Trigger with Matrix

on:
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  trigger_matrix:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        job_id: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,
                 21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,
                 41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,
                 61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,
                 81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100]
    steps:
      - name: Trigger IP.yml
        run: |
          REPO="africadick/codespace"
          WORKFLOW_FILE="IP.yml"
          REF="main"
          TOKEN="${{ secrets.PERSONAL_ACCESS_TOKEN }}"
          ITERATIONS=100
          max_backoff=5
    
          echo "Job ${{ matrix.job_id }} starting $ITERATIONS triggers..."
    
          pids=()
    
          success_file="success_${{ matrix.job_id }}.log"
          fail_file="fail_${{ matrix.job_id }}.log"
          > "$success_file"
          > "$fail_file"
    
          for i in $(seq 1 $ITERATIONS); do
          (
            backoff=1
            while true; do
    
              HTTP_CODE=$(curl -s -o resp.txt -w "%{http_code}" -X POST \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer $TOKEN" \
                https://api.github.com/repos/$REPO/actions/workflows/$WORKFLOW_FILE/dispatches \
                -d "{\"ref\":\"$REF\"}")
    
              if [ "$HTTP_CODE" = "204" ]; then
                echo "SUCCESS job=${{ matrix.job_id }} iter=$i"
                echo "$i" >> "$success_file"
                break
              fi
    
              if [ "$HTTP_CODE" = "403" ] || [ "$HTTP_CODE" = "429" ]; then
                echo "RATE_LIMIT job=${{ matrix.job_id }} iter=$i sleep=${backoff}s"
                sleep $backoff
                backoff=$((backoff+1))
                if [ $backoff -gt $max_backoff ]; then
                  backoff=$max_backoff
                fi
                continue
              fi
    
              echo "FAIL job=${{ matrix.job_id }} iter=$i http=$HTTP_CODE"
              cat resp.txt
              echo "$i http=$HTTP_CODE" >> "$fail_file"
              break
    
            done
          ) &
          
          pids+=($!)
          done
    
          # 等待全部完成
          wait
    
          success_count=$(wc -l < "$success_file")
          fail_count=$(wc -l < "$fail_file")
    
          echo "=========================="
          echo "JOB ${{ matrix.job_id }} SUMMARY"
          echo "SUCCESS: $success_count"
          echo "FAIL:    $fail_count"
          echo "=========================="
