name: APP Cancel All Workflow Runs

on:
  workflow_dispatch:

jobs:
  cancel-runs:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies and set ESM
        run: |
          npm init -y
          npm install @octokit/auth-app @octokit/rest
          jq '. + {"type":"module"}' package.json > package_tmp.json && mv package_tmp.json package.json

            - name: Cancel workflow runs
        env:
          APP_ID: "2823042"
          PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}
          OWNER: "porndreamer"
          REPO: "codespace"
        run: |
          cat << 'EOF' > cancel.js
          import { createAppAuth } from '@octokit/auth-app';
          import { Octokit } from '@octokit/rest';

          const APP_ID = process.env.APP_ID;
          const PRIVATE_KEY = process.env.PRIVATE_KEY.replace(/\\n/g, "\n");
          const OWNER = process.env.OWNER;
          const REPO = process.env.REPO;
          const TARGET_STATUS = ["in_progress","queued","waiting","pending","requested"];
          const CONCURRENCY = 70; // 并发数量，可调

          async function main() {
            try {
              const authApp = createAppAuth({ appId: APP_ID, privateKey: PRIVATE_KEY });

              // 获取安装 token
              const appAuthentication = await authApp({ type: "app" });
              const appOctokit = new Octokit({ auth: appAuthentication.token });
              const installsRes = await appOctokit.rest.apps.listInstallations();

              let installationId = null;
              for (const inst of installsRes.data) {
                const repoInst = await appOctokit.rest.apps.getRepoInstallation({
                  owner: OWNER,
                  repo: REPO,
                }).catch(() => null);

                if (repoInst && repoInst.data) {
                  installationId = inst.id;
                  break;
                }
              }

              if (!installationId) throw new Error("Installation not found");

              const installationAuth = await authApp({
                type: "installation",
                installationId,
              });
              const octokit = new Octokit({ auth: installationAuth.token });

              // 1️⃣ 先收集所有 run ID
              const allRunIds = [];

              for (const status of TARGET_STATUS) {
                let page = 1;
                while (true) {
                  const res = await octokit.rest.actions.listWorkflowRunsForRepo({
                    owner: OWNER,
                    repo: REPO,
                    status,
                    per_page: 100,
                    page,
                  });

                  const runs = res.data.workflow_runs;
                  console.log(`Status=${status} Page=${page} found ${runs.length} runs`);

                  allRunIds.push(...runs.map(run => run.id));

                  if (runs.length < 100) break;
                  page++;
                }
              }

              console.log(`Total runs to cancel: ${allRunIds.length}`);

              // 2️⃣ 并发取消
              let totalCanceled = 0;

              async function cancelBatch(batch) {
                await Promise.all(batch.map(async (runId) => {
                  try {
                    await octokit.rest.actions.cancelWorkflowRun({
                      owner: OWNER,
                      repo: REPO,
                      run_id: runId,
                    });
                    totalCanceled++;
                    console.log("Canceled run:", runId);
                  } catch (e) {
                    console.log("Failed to cancel run:", runId, e.message);
                  }
                }));
              }

              for (let i = 0; i < allRunIds.length; i += CONCURRENCY) {
                const batch = allRunIds.slice(i, i + CONCURRENCY);
                await cancelBatch(batch);
              }

              console.log("Total runs canceled:", totalCanceled);

            } catch (err) {
              console.error("Error:", err);
            }
          }

          main();
          EOF

          node cancel.js


          main();
          EOF

          node cancel.js
