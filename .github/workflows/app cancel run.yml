name: APP Cancel All Workflow Runs

on:
  workflow_dispatch:

jobs:
  cancel-runs:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies and set ESM
        run: |
          npm init -y
          npm install @octokit/app@14 @octokit/rest@21
          # 设置 package.json 为 ESM，防止 import 报错
          jq '. + {"type":"module"}' package.json > package_tmp.json && mv package_tmp.json package.json

      - name: Cancel workflow runs
        env:
          APP_ID: "2823042"
          PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}
          OWNER: "porndreamer"
          REPO: "codespace"
        run: |
          cat << 'EOF' > cancel.js
          import { App } from "@octokit/app";
          import { Octokit } from "@octokit/rest";

          const APP_ID = process.env.APP_ID;
          const PRIVATE_KEY = process.env.PRIVATE_KEY;
          const OWNER = process.env.OWNER;
          const REPO = process.env.REPO;

          const TARGET_STATUS = ["in_progress","queued","waiting","pending","requested"];

          async function main() {
            try {
              // 创建 GitHub App
              const app = new App({
                appId: APP_ID,
                privateKey: PRIVATE_KEY.replace(/\\n/g,"\n")
              });

              // 用 JWT 创建 Octokit，访问 /app/installations
              const jwt = app.getSignedJsonWebToken();
              const appOctokit = new Octokit({ auth: jwt });

              console.log("Fetching installations...");
              const installsRes = await appOctokit.request("GET /app/installations");
              if (!installsRes.data.length) throw new Error("No installations found");

              // 匹配目标仓库所属安装
              const installation = installsRes.data.find(i => i.account.login === OWNER);
              if (!installation) throw new Error("Installation not found for owner");

              console.log("Using installation ID:", installation.id);

              // 用 installation token 创建 Octokit，操作仓库
              const installationOctokit = await app.getInstallationOctokit(installation.id);

              let totalCanceled = 0;

              for (const status of TARGET_STATUS) {
                let page = 1;
                while (true) {
                  const res = await installationOctokit.request(
                    "GET /repos/{owner}/{repo}/actions/runs",
                    {
                      owner: OWNER,
                      repo: REPO,
                      status,
                      per_page: 100,
                      page
                    }
                  );

                  const runs = res.data.workflow_runs;
                  console.log(`Status=${status} Page=${page} found ${runs.length} runs`);

                  if (!runs.length) break;

                  for (const run of runs) {
                    try {
                      await installationOctokit.request(
                        "POST /repos/{owner}/{repo}/actions/runs/{run_id}/cancel",
                        { owner: OWNER, repo: REPO, run_id: run.id }
                      );
                      totalCanceled++;
                      console.log("Canceled run:", run.id);
                    } catch(e) {
                      console.log("Failed to cancel run:", run.id, e.message);
                    }
                  }

                  if (runs.length < 100) break;
                  page++;
                }
              }

              console.log("Total runs canceled:", totalCanceled);

            } catch (err) {
              console.error("Error:", err);
            }
          }

          main();
          EOF

          node cancel.js
