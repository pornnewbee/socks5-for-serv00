name: Cancel Runs (App Auto Installation)

on:
  workflow_dispatch:

jobs:
  cancel-runs:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: |
          npm init -y
          npm install @octokit/app @octokit/rest

      - name: Cancel runs via GitHub App
        env:
          APP_ID: "2823042"
          PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}
          OWNER: "porndreamer"
          REPO: "codespace"

        run: |
          cat << 'EOF' > cancel.js
          import { App } from "@octokit/app";
          import { Octokit } from "@octokit/rest";

          const APP_ID = process.env.APP_ID;
          const PRIVATE_KEY = process.env.PRIVATE_KEY;

          const OWNER = process.env.OWNER;
          const REPO = process.env.REPO;

          const TARGET_STATUS = [
            "in_progress",
            "queued",
            "waiting",
            "pending",
            "requested"
          ];

          async function main() {

            const app = new App({
              appId: APP_ID,
              privateKey: PRIVATE_KEY.replace(/\\n/g, "\n"),
            });

            console.log("Creating App Octokit (JWT auth)...");

            const appOctokit = await app.getOctokit();

            console.log("Fetching installations...");

            const installs = await appOctokit.request(
              "GET /app/installations"
            );

            if (!installs.data.length) {
              throw new Error("No installations found");
            }

            // ⭐ 自动找匹配 repo 的 installation
            let installationId = null;

            for (const inst of installs.data) {

              const repos = await appOctokit.request(
                "GET /installation/repositories",
                {
                  headers: {
                    authorization: `Bearer ${await app.getAppAuthentication().then(a => a.token)}`
                  }
                }
              );

              if (repos.data.repositories.find(r => r.name === REPO)) {
                installationId = inst.id;
                break;
              }
            }

            if (!installationId) {
              console.log("Fallback: using first installation");
              installationId = installs.data[0].id;
            }

            console.log("Using installation:", installationId);

            const installationOctokit =
              await app.getInstallationOctokit(installationId);

            let totalCanceled = 0;

            for (const status of TARGET_STATUS) {

              let page = 1;

              while (true) {

                const res = await installationOctokit.request(
                  "GET /repos/{owner}/{repo}/actions/runs",
                  {
                    owner: OWNER,
                    repo: REPO,
                    status,
                    per_page: 100,
                    page
                  }
                );

                const runs = res.data.workflow_runs;

                if (!runs.length) break;

                for (const run of runs) {
                  try {
                    await installationOctokit.request(
                      "POST /repos/{owner}/{repo}/actions/runs/{run_id}/cancel",
                      {
                        owner: OWNER,
                        repo: REPO,
                        run_id: run.id
                      }
                    );

                    totalCanceled++;
                    console.log("Canceled:", run.id);

                  } catch (e) {
                    console.log("Cancel fail:", run.id);
                  }
                }

                if (runs.length < 100) break;

                page++;
              }
            }

            console.log("Total canceled:", totalCanceled);
          }

          main().catch(console.error);
          EOF

          node cancel.js
