name: Check WS (2095)

on:
  workflow_dispatch:

jobs:
  check-ws:
    runs-on: ubuntu-latest

    steps:
      - name: Test WS handshake on port 2095
        run: |
          set -e

          HOST="icy-river-2da8.alt-00e.workers.dev"
          URL="http://$HOST:2095/"
          
          STATUS=$(curl --http1.1 \
            --max-time 5 \
            --connect-timeout 5 \
            -s -o /dev/null -w "%{http_code}" \
            -H "Host: $HOST" \
            -H "Connection: Upgrade" \
            -H "Upgrade: websocket" \
            -H "Sec-WebSocket-Version: 13" \
            -H "Sec-WebSocket-Key: SGVsbG9Xb3JsZA==" \
            "$URL" 2>/dev/null || echo "000")
          
          echo "WS HTTP status: $STATUS"
          
          # 只要明确拿到了状态码
          if [ "$STATUS" = "101" ]; then
            echo "✅ WS handshake OK (101)"
            exit 0
          fi
          
          # 连状态码都没拿到
          if [ "$STATUS" = "000" ]; then
            echo "❌ Failed to get HTTP status (connection error / timeout before response)"
            exit 1
          fi
          
          # 其他状态码
          echo "❌ WS handshake failed (status=$STATUS)"
          exit 1
