name: Check WS (2095)

on:
  workflow_dispatch:

jobs:
  check-ws:
    runs-on: ubuntu-latest

    steps:
      - name: Test WS handshake on port 2095
        run: |
          set -e

          HOST="icy-river-2da8.alt-00e.workers.dev"
          URL="http://$HOST:2095/"
          
          STATUS=$(curl --http1.1 \
            --max-time 5 \
            --connect-timeout 5 \
            -s -o /dev/null -w "%{http_code}" \
            -H "Host: $HOST" \
            -H "Connection: Upgrade" \
            -H "Upgrade: websocket" \
            -H "Sec-WebSocket-Version: 13" \
            -H "Sec-WebSocket-Key: SGVsbG9Xb3JsZA==" \
            "$URL" 2>/dev/null || true)
          
          # 兜底：curl 在“完全没响应”时会返回空
          STATUS=${STATUS:-000}
          
          echo "WS HTTP status: $STATUS"
          
          if [ "$STATUS" = "101" ]; then
            echo "✅ WS handshake OK (101)"
            exit 0
          fi
          
          if [ "$STATUS" = "000" ]; then
            echo "❌ Failed to get HTTP status"
            exit 1
          fi
          
          echo "❌ WS handshake failed (status=$STATUS)"
          exit 1
