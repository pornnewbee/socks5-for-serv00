name: Cancel All Running and Queued Actions

on:
  workflow_dispatch:

jobs:
  cancel_all:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Cancel all running and queued workflow runs (concurrent)
        env:
          TARGET_OWNER: wearingdurex
          TARGET_REPO: codespace
          PAT: ${{ secrets.PAT }}
        run: |
          statuses=("in_progress" "queued")
          all_runs=()

          for status in "${statuses[@]}"; do
            page=1
            while true; do
              echo "Fetching $status runs, page $page..."
              response=$(curl -s -H "Authorization: token $PAT" \
                "https://api.github.com/repos/$TARGET_OWNER/$TARGET_REPO/actions/runs?status=$status&per_page=100&page=$page")

              runs=$(echo "$response" | jq -r '.workflow_runs[].id')
              if [ -z "$runs" ]; then
                break
              fi

              all_runs+=($runs)

              total_count=$(echo "$response" | jq -r '.total_count')
              if [ $(($page * 100)) -ge $total_count ]; then
                break
              fi

              page=$((page + 1))
            done
          done

          if [ ${#all_runs[@]} -eq 0 ]; then
            echo "No running or queued workflow runs found."
            exit 0
          fi

          echo "Cancelling all workflow runs concurrently..."
          for run_id in "${all_runs[@]}"; do
            echo "Cancelling run $run_id ..."
            curl -s -X POST -H "Authorization: token $PAT" \
              "https://api.github.com/repos/$TARGET_OWNER/$TARGET_REPO/actions/runs/$run_id/cancel" &
          done

          # 等待所有后台 cancel 请求完成
          wait
          echo "Done cancelling all running and queued workflow runs."
