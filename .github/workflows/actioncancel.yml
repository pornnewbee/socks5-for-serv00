name: Cancel All Running and Queued Actions (gh CLI)

on:
  workflow_dispatch:

jobs:
  cancel_all:
    runs-on: ubuntu-latest
    steps:
      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq

      - name: Authenticate GitHub CLI
        env:
          PAT: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          echo "$PAT" | gh auth login --with-token

      - name: Cancel all running and queued workflow runs
        env:
          TARGET_OWNER: africadick
          TARGET_REPO: codespace
        run: |
          echo "Fetching all running and queued workflow runs..."
          runs=$(gh run list --repo $TARGET_OWNER/$TARGET_REPO --limit 1000 --json databaseId,status | \
                 jq -r '.[] | select(.status=="queued" or .status=="in_progress") | .databaseId')

          if [ -z "$runs" ]; then
            echo "No running or queued workflow runs found."
            exit 0
          fi

          echo "Cancelling workflow runs..."
          for run_id in $runs; do
            echo "Cancelling run $run_id ..."
            gh run cancel $run_id --repo $TARGET_OWNER/$TARGET_REPO &
          done

          wait
          echo "Done cancelling all running and queued workflow runs."
