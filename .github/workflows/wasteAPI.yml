name: Infinite Parallel-Workflow Trigger

on:
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  trigger_loop:
    runs-on: ubuntu-latest
    steps:
      - name: Infinite parallel trigger loop with global linear backoff
        run: |
          REPO="africadick/codespace"      # 目标仓库
          WORKFLOW_FILE="IP.yml"           # 目标 workflow 文件
          REF="main"                       # 分支
          TOKEN="${{ secrets.PERSONAL_ACCESS_TOKEN }}"
          PARALLEL=100                      # 并发数量

          echo "Starting infinite parallel trigger loop for $REPO/$WORKFLOW_FILE..."

          backoff=1           # 初始退避秒数
          max_backoff=5

          while true; do
            hit_limit=0  # 标记这一批是否遇到 secondary limit

            for i in $(seq 1 $PARALLEL); do
              (
                RESPONSE=$(curl -s -X POST \
                  -H "Accept: application/vnd.github+json" \
                  -H "Authorization: Bearer $TOKEN" \
                  https://api.github.com/repos/$REPO/actions/workflows/$WORKFLOW_FILE/dispatches \
                  -d "{\"ref\":\"$REF\"}")

                if echo "$RESPONSE" | grep -q "secondary rate limit"; then
                  hit_limit=1
                  echo "Hit secondary rate limit in this batch."
                fi
              ) &
            done

            wait  # 等待这一批并发完成

            if [ $hit_limit -eq 1 ]; then
              echo "Backing off ${backoff}s due to secondary rate limit..."
              sleep $backoff
              backoff=$((backoff + 1))
              if [ $backoff -gt $max_backoff ]; then
                backoff=$max_backoff
              fi
            else
              backoff=1  # 没遇到限制就重置退避
            fi
          done
