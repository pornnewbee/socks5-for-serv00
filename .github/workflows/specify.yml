name: Cancel Specific Workflow Runs

on:
  workflow_dispatch:
    inputs:
      workflow_file:
        description: 'Name of the workflow YAML file to cancel (e.g., test.yml)'
        required: true
        default: ''

jobs:
  cancel_specific:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Cancel runs of specified workflow
        env:
          TARGET_OWNER: africadick
          TARGET_REPO: codespace
          PAT: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          WORKFLOW_FILE: ${{ github.event.inputs.workflow_file }}
        run: |
          if [ -z "$WORKFLOW_FILE" ]; then
            echo "Workflow file not provided. Exiting."
            exit 1
          fi

          echo "Finding workflow ID for $WORKFLOW_FILE..."
          workflow_id=$(curl -s -H "Authorization: token $PAT" \
            "https://api.github.com/repos/$TARGET_OWNER/$TARGET_REPO/actions/workflows" \
            | jq -r --arg file "$WORKFLOW_FILE" '.workflows[] | select(.path==$file) | .id')

          if [ -z "$workflow_id" ]; then
            echo "Workflow $WORKFLOW_FILE not found in $TARGET_REPO."
            exit 1
          fi

          echo "Listing all running/pending runs for workflow $WORKFLOW_FILE..."
          runs=$(curl -s -H "Authorization: token $PAT" \
            "https://api.github.com/repos/$TARGET_OWNER/$TARGET_REPO/actions/workflows/$workflow_id/runs?status=in_progress,pending&per_page=100" \
            | jq -r '.workflow_runs[].id')

          if [ -z "$runs" ]; then
            echo "No running or pending runs found."
            exit 0
          fi

          for run_id in $runs; do
            echo "Cancelling run $run_id..."
            curl -s -X POST -H "Authorization: token $PAT" \
              "https://api.github.com/repos/$TARGET_OWNER/$TARGET_REPO/actions/runs/$run_id/cancel"
          done
