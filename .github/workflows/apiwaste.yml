name: api waste

on:
  workflow_dispatch:

jobs:
  api-dispatcher:
    runs-on: ubuntu-latest
    steps:
      - name: api-dispatcher
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const workflowFileName = 'showip.yml'; // 目标 workflow 文件名
            const owner = 'porndreamer';
            const repo = 'codespace';
            const runs = 1000;

            // 工具函数：等待指定秒数
            const sleep = (s) => new Promise(resolve => setTimeout(resolve, s * 1000));

            for (let i = 0; i < runs; i++) {
              let success = false;
              while (!success) {
                try {
                  await github.rest.actions.createWorkflowDispatch({
                    owner,
                    repo,
                    workflow_id: workflowFileName,
                    ref: 'main',
                    inputs: {}
                  });
                  console.log(`Triggered ${i + 1}/${runs}`);
                  success = true;
                } catch (err) {
                  // 检查是否 secondary rate limit
                  const msg = err.message || '';
                  if (msg.includes('secondary rate limit')) {
                    // 获取 retry-after，如果没有就默认 5 秒
                    const retryAfter = err.response?.headers?.['retry-after'] || 5;
                    console.log(`Hit secondary rate limit. Retrying after ${retryAfter}s...`);
                    await sleep(Number(retryAfter));
                  } else {
                    console.error(`Failed to trigger workflow ${i + 1}:`, err);
                    break; // 其他错误直接跳出循环
                  }
                }
              }
            }
